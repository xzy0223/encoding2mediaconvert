---
# Enhanced rules for multi-stream conversion from encoding.com to AWS MediaConvert
# This file contains specialized rules for handling multiple streams in different output formats

rules:
  # Basic settings that apply to all formats
  - source:
      path: segment_duration
    target:
      path: Settings.OutputGroups[0].OutputGroupSettings.CmafGroupSettings.SegmentLength
      
  - source:
      path: fragment_duration
    target:
      path: Settings.OutputGroups[0].OutputGroupSettings.CmafGroupSettings.FragmentLength
      
  - source:
      path: playlist_version
    target:
      path: Settings.OutputGroups[0].OutputGroupSettings.CmafGroupSettings.MinSegmentLength
      
  # Stream-specific rules are now handled by the StreamProcessor class
  - source:
      path: stream
      type: dummy
      
  # Audio-specific mappings
  - source:
      path: audio_codec
    target:
      path: Settings.OutputGroups[0].Outputs[0].AudioDescriptions[0].CodecSettings.Codec
      transform: audio_codec_format
      
  - source:
      path: audio_bitrate
    target:
      path: Settings.OutputGroups[0].Outputs[0].AudioDescriptions[0].CodecSettings.AacSettings.Bitrate
      transform: audio_bitrate_format
      
  - source:
      path: audio_sample_rate
    target:
      path: Settings.OutputGroups[0].Outputs[0].AudioDescriptions[0].CodecSettings.AacSettings.SampleRate
      
  - source:
      path: audio_channels_number
    target:
      path: Settings.OutputGroups[0].Outputs[0].AudioDescriptions[0].CodecSettings.AacSettings.CodingMode
      transform: audio_channels_format
      
  # Video-specific mappings
  - source:
      path: video_codec
    target:
      path: Settings.OutputGroups[0].Outputs[0].VideoDescription.CodecSettings.Codec
      transform: video_codec_format
      
  - source:
      path: size
    target:
      - path: Settings.OutputGroups[0].Outputs[0].VideoDescription.Width
        transform: width_format
      - path: Settings.OutputGroups[0].Outputs[0].VideoDescription.Height
        transform: height_format
        
  - source:
      path: framerate
    target:
      path: Settings.OutputGroups[0].Outputs[0].VideoDescription.CodecSettings.H264Settings.FramerateNumerator
      
  - source:
      path: keyframe
    target:
      path: Settings.OutputGroups[0].Outputs[0].VideoDescription.CodecSettings.H264Settings.GopSize
      
  - source:
      path: profile
    target:
      path: Settings.OutputGroups[0].Outputs[0].VideoDescription.CodecSettings.H264Settings.CodecProfile
      transform: profile_format
      
  - source:
      path: level
    target:
      path: Settings.OutputGroups[0].Outputs[0].VideoDescription.CodecSettings.H264Settings.CodecLevel
      transform: level_format

# Transformers for mapping encoding.com values to MediaConvert values
transformers:
  audio_codec_format:
    libfaac: AAC
    dolby_aac: AAC
    dolby_heaac: AAC
    aac: AAC
    libmp3lame: MP3
    libvorbis: VORBIS
    ac3: AC3
    eac3: EAC3
    
  video_codec_format:
    libx264: H_264
    libx265: H_265
    vp9: VP9
    av1: AV1
    
  audio_bitrate_format:
    32k: 32000
    48k: 48000
    64k: 64000
    96k: 96000
    128k: 128000
    192k: 192000
    256k: 256000
    320k: 320000
    
  audio_channels_format:
    "1": CODING_MODE_1_0
    "2": CODING_MODE_2_0
    "6": CODING_MODE_5_1
    
  profile_format:
    baseline: BASELINE
    main: MAIN
    high: HIGH
    high10: HIGH10
    
  level_format:
    "30": LEVEL_3
    "31": LEVEL_3_1
    "40": LEVEL_4
    "41": LEVEL_4_1
    "42": LEVEL_4_2
    "50": LEVEL_5
    "51": LEVEL_5_1
    "52": LEVEL_5_2
    
  width_format:
    regex: (\d+)x\d+
    format: $1
    
  height_format:
    regex: \d+x(\d+)
    format: $1
